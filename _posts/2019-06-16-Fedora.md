---
layout: post
date: 2019-06-16 22:30:52 +0300
title: Minimal Fedora Installation via Chroot
tags: fedora uefi systemd-boot efistub chroot
---

## Why

Well, probably not much outside of having a better grasp on how the system comes together, and with that knowledge comes greater room for customization.  
This is not for people who want to get a working system as quickly as possible, the anaconda installer does a fine enough job for that purpose (Although there are some cases where it may be more of a headache).  
Nevertheless, this is aimed at the control freaks and/or those who want to learn.

<!--end_excerpt-->

## How

Not much different from a typical Arch Linux or Debian installation via `debootstrap` program, although with some quirks.

## Preperation

- Acquire a [Fedora Workstation](https://getfedora.org/en/workstation/download/) image.
- Create a bootable USB with that image.
- Get comfortable with the live system: Set keyboard layout, connect to internet etc.
- Open a terminal and acquire root.
- Disable enforcing selinux with `setenforce 0`, this is only required for setting the password for the new user that you'll create.
- Acquire the `genfstab` script which makes it easier to create the `/etc/fstab`. The script is originally from [Arch Install Scripts](https://git.archlinux.org/arch-install-scripts.git), but for convenience you can acquire it and add executable permission with this command:  
  `wget https://github.com/glacion/genfstab/releases/download/1.0/genfstab; chmod +x genfstab`

## Partitioning

This is pretty straightforward if you have ever done an Arch installation or something similar.  
If you are not familiar with partitioning however, get comfortable with it. [Arch Wiki](https://wiki.archlinux.org/index.php/Partitioning) is a great resource.  
For reference, these are the partitions i use for testing in a VM with a drive of 12GiB:

- `/dev/sda1` ESP partition of size 100MiB, to be mounted on `/boot`.
- `/dev/sda2` swap partition of size 1.9GiB.
- `/dev/sda3` XFS partition of size 10GiB, to be mounted on `/`.

I chose `/mnt` to be my install root, you may change to your preference but be sure to update the commands accordingly.

## Installing The Base System

Assuming that your partitions are mounted on `/mnt`, install the base system like below:

```console
dnf install \
--installroot=/mnt \
--releasever=30 \
--setopt=install_weak_deps=False \
--setopt=keepcache=True \
--assumeyes \
--nodocs \
glibc-langpack-en deltarpm xfsprogs zchunk sqlite @Core
```

- `releasever=29` Install fedora 30, change if desired.
- `setopt=install_weak_deps=False` Do not install weak dependencies, synonymous to apt's `--no-install-recommends`.
- `assumeyes` Don't ask for user input.
- `nodocs` Don't install documentation.
- `glibc-langpack-en` English langpack for glibc, in order to have a localized system install `glibc-langpack-<LANGCODE>` if no langpack is specified to install, dnf will install `glibc-all-langpacks` package which costs 100MB alone compared to installing them seperately which costs around 1MB per langpack. Use a different langcode if you want to use a different locale.
- `sqlite` is helpful for `dnf` completions, but not that necessary.
- `xfsprogs` is necessary since i used an `xfs` root. If you used `ext4`, you don't need to install this, `e2fsprogs` comes with the `Core` group, install the tools for your selected filesystem otherwise.
- `lz4` will be used for compressing the initramfs. **NOTE:** Change this if you will be using a different compression method.
- `Core` group is the smallest possible installation according to Fedora, similar to the `base` group in Arch.

## Configuration

- Setup machine id and configure the system locale, keymap, timezone, hostname on your new system;

  ```console
  systemd-firstboot \
  --root=/mnt \
  --locale=C.UTF-8 \
  --keymap=us \
  --timezone=Europe/Istanbul \
  --hostname=fedora \
  --setup-machine-id
  ```

- Generate fstab and save it in your new system, replace `-U` with `-L` if you want to use labels instead of UUIDs in your `/etc/fstab`

  ```console
  ./genfstab -U /mnt >> /mnt/etc/fstab
  ```

- Chroot without booting and add an user

  ```console
  systemd-nspawn -D /mnt
  useradd -c "<YOUR_FULL_NAME>" -m -g users -G wheel -s /bin/bash <YOUR_USERNAME>
  passwd <YOUR_USERNAME>
  exit
  ```

- Boot the system as a container

  ```console
  systemd-nspawn -bD /mnt
  ```

  Login with the newly created user and get root with `sudo -s`, commands until the `exit` will be executed in the container.

- Package cleanup (Optional)
  Even though the `Core` group is pretty small, it has some stuff that you might not need, so i am removing the ones that i won't need here.

  ```console
  dnf remove sssd* plymouth man-db parted openssh-server e2fsprogs dhcp-client dracut-config-rescue
  ```

- DNF configuration

  - Delete unnecessary repositories with `rm -f /mnt/etc/yum.repos.d/*{*cisco*,*testing*,*modular*}*`

  - Add following options to `/etc/dnf/dnf.conf`

    ```console
    install_weak_deps=False
    keepcache=True
    tsflags=nodocs
    ```

- Install the bootloader

  `systemd-boot` is a fairly minimal and gets the job done without much configuration. If you opt to use `GRUB` or something similar, you are on your own.

  ```console
  bootctl install
  ```

- Add `dracut` configuration

  Dracut is the tool for creating initramfs on Fedora, Customizing its configuration is required since we have a `xfs` root and dracut needs to know that.

  - Open `/etc/dracut.conf.d/custom.conf` with your favorite editor and add the following, don't add `drivers+="i915"` line if you are not using an intel graphics card, and change filesystems according to your root filesystem.

    ```console
    filesystems+="xfs"
    drivers+="i915"
    compress="lz4"
    hostonly="yes"
    ```

- Installing the kernel
  Technically, the kernel is installed as a dependency but not completely, so install the remaining of it and reinstall the `kernel-core` so it can generate in compliance to `systemd-boot`.

  ```console
  dnf install kernel ; dnf reinstall kernel-core
  ```

- Configuring the bootloader

  When you installed the kernel, the bootloader created an entry at `/boot/loader/entries/<MACHINE_ID>-<KVER>.conf`, however it just copied the boot parameters of the live system.

  The `options` part of the file shows something like this:

  ```console
  options    BOOT_IMAGE=/images/pxeboot/vmlinuz root=live:CDLABEL=Fedora-WS-Live-30-1-2 rd.live.image quiet
  ```

  Change it to something like this:

  ```console
  options    root=UUID=<UUID_OF_ROOT_PARTITION> ro quiet
  ```

Add the kernel parameters that you want to include here.

- SELinux

  The newly installed system will fail most of its capabilities as SELinux labels are broken after the initial installation. Issuing `fixfiles -F onboot` will cause the system to relabel on the next boot.

- Exit the container with `poweroff`

- EFI Entry

  Create an EFI entry using `efibootmgr` like this:

  ```console
  efibootmgr -d /dev/sda -p 1 -c -L "Fedora" -l /EFI/systemd/systemd-bootx64.efi
  ```

- Clean up and reboot

  ```console
  umount -R /mnt
  reboot
  ```
